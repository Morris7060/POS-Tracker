<!doctype html>
<html lang="en" x-data="app()" x-init="initApp()">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ICT Admin ‚Äî Enterprise POS Dashboard</title>
  <link rel="icon" href="logo.png" type="image/png" />

  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="main.js" type="module"></script>


  <style>[x-cloak]{display:none!important} .cursor-sort{cursor:pointer}</style>
</head>
<body class="bg-white text-slate-900">

<script>
/* -----------------------
  CONFIG: your Supabase
  Keep the URL, replace the KEY locally with your real anon key.
----------------------- */
const SUPABASE_URL = 'https://drvkqsjlartfeatujwzu.supabase.co';
// Replace 'YOUR_SUPABASE_ANON_KEY' with your real key locally
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRydmtxc2psYXJ0ZmVhdHVqd3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwODI0NjIsImV4cCI6MjA3NTY1ODQ2Mn0.GZpN-ciQaP25izB1f8OZaLOOstCuaKrfDSWnE7x_79c';

window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<div class="min-h-screen flex">

  <aside class="w-72 bg-sky-800 text-white flex flex-col">
    <div class="p-4 border-b border-sky-700 flex items-center gap-3">
      <img src="image/logo (2).png" alt="Logo" class="w-10 h-10 object-contain rounded-sm shadow-sm" onerror="this.style.display='none'"/>
      <div>
        <div class="font-bold text-lg">ICT Admin</div>
        <div class="text-xs opacity-80">POS Tracking </div>
      </div>
    </div>

    <nav class="p-4 flex-1 space-y-1">
      <button @click.prevent="nav('dashboard')" :class="view==='dashboard'?'bg-sky-700':''" class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
      </button>

      <button @click.prevent="nav('supervisors')" 
              :class="view==='supervisors'?'bg-sky-700':''"
              class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="users" class="w-5 h-5"></i><span>Supervisors</span>
      </button>

      <button @click.prevent="nav('agents')" :class="view==='agents'?'bg-sky-700':''" class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="user" class="w-5 h-5"></i><span>Agents</span>
      </button>

      <button @click.prevent="nav('pos')" :class="view==='pos'?'bg-sky-700':''" class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="tablet-smartphone" class="w-5 h-5"></i><span>POS Devices</span>
      </button>

      <button @click.prevent="nav('logs')" :class="view==='logs'?'bg-sky-700':''" class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="activity" class="w-5 h-5"></i><span>Activity Logs</span>
      </button>
<button @click.prevent="nav('report'); fetchAgentsPerSupervisor()" 
        :class="view==='report'?'bg-sky-700':''" 
        class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
    <i data-lucide="file-text" class="w-5 h-5"></i><span>Report</span>
</button>


      <button @click.prevent="nav('settings')" :class="view==='settings'?'bg-sky-700':''" class="w-full text-left px-3 py-2 rounded flex items-center gap-3">
        <i data-lucide="settings" class="w-5 h-5"></i><span>Settings</span>
      </button>
    </nav>

    <div class="p-4 border-t border-sky-700 text-xs">
      <div class="opacity-80">Signed in as</div>
      <div class="font-semibold"> ICT Officer</div>
    </div>
  </aside>

  <main class="flex-1 p-6 overflow-auto">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 id="pageTitle" class="text-2xl font-bold">Dashboard</h1>
        <p id="pageSub" class="text-sm opacity-70">Enterprise POS ‚Äî sorting, pagination, RLS-ready</p>
      </div>

      <div class="flex items-center gap-3">
        <input x-model="globalSearch" @input="applySearch()" placeholder="Search supervisors, agents, POS..." class="p-2 border rounded w-80" aria-label="Global search" />
        <button @click="refreshAll()" class="bg-white px-3 py-2 rounded border">üîÑ Refresh</button>
      </div>
    </header>
      <!-- REPORT Section -->
  <section x-show="view==='report'" x-cloak x-data="agentsReport()">
  <h2 class="text-2xl font-bold mb-4">Agents per Supervisor</h2>

  <!-- Supervisor Dropdown -->
  <div class="mb-4">
    <label for="supervisorSelect" class="font-semibold block mb-1">Select Supervisor:</label>
    <select id="supervisorSelect" x-model="selectedSupervisorId"
            class="w-full p-2 border rounded">
      <option value="">-- Choose Supervisor --</option>
      <template x-for="group in agentsPerSupervisor" :key="group.supervisor_id">
        <option :value="group.supervisor_id" x-text="group.supervisor"></option>
      </template>
    </select>
  </div>

  <!-- Agents Table -->
  <div class="bg-white rounded shadow p-4 overflow-auto max-h-[60vh]">
    <template x-if="selectedSupervisorAgents.length > 0">
      <table class="table-auto w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-4 py-2">Agent Name</th>
            <th class="border px-4 py-2">Contact</th>
            <th class="border px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(agent, index) in selectedSupervisorAgents" :key="agent.agent_id">
            <tr :class="index % 2 === 0 ? 'bg-white' : 'bg-gray-50'">
              <td class="border px-4 py-2" x-text="agent.name"></td>
              <td class="border px-4 py-2" x-text="agent.contact || 'No contact'"></td>
              <td class="border px-4 py-2 space-x-2">
                <button class="bg-blue-500 text-white px-2 py-1 rounded"
                        @click="editAgent(agent)">Edit</button>
                <button class="bg-red-500 text-white px-2 py-1 rounded"
                        @click="deleteAgent(agent)">Delete</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </template>
    <template x-if="selectedSupervisorAgents.length === 0">
      <p class="text-gray-500">No agents available for this supervisor.</p>
    </template>
  </div>

  <!-- Export Buttons -->
  <div class="mt-4 flex gap-2">
    <button class="bg-white text-sky-700 px-3 py-2 rounded border"
            @click="exportAgentsPerSupervisorPDF()">Export PDF</button>
    <button class="bg-white text-sky-700 px-3 py-2 rounded border"
            @click="exportAgentsPerSupervisorCSV()">Export CSV</button>
  </div>
</section>




<!-- Greeting & Time Section -->
<div class="p-4 bg-white rounded-2xl shadow-md mb-6 flex flex-col items-start">
  <h2 id="greeting" class="text-2xl font-bold text-gray-800"></h2>
  <p id="time" class="text-lg text-gray-500"></p>
</div>

<!-- Dashboard Section -->
<section x-show="view==='dashboard'" x-cloak>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Summary Cards -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-semibold">Supervisors</h3>
      <p class="text-2xl font-bold text-slate-700" x-text="counts.supervisors"></p>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-semibold">Agents</h3>
      <p class="text-2xl font-bold text-slate-700" x-text="counts.agents"></p>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-semibold">POS Devices</h3>
      <p class="text-2xl font-bold text-slate-700" x-text="counts.pos"></p>
    </div>
  </div>
<div class="bg-white p-4 rounded shadow h-[400px] overflow-hidden">
  <canvas id="desktopChart"></canvas>
</div>

  <!-- Chart Card -->
  <div class="bg-white p-4 rounded shadow mt-6 max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Agents per Supervisor</h3>
      <button
        class="bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded text-sm flex items-center gap-1"
        @click="toggleChartType()"
        aria-pressed="false"
      >
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        <span x-text="chartType === 'bar' ? 'Switch to Pie' : 'Switch to Bar'"></span>
      </button>
    </div>
    <div class="h-72 relative">
      <canvas id="agentsChart" aria-label="Agents per supervisor chart"></canvas>
    </div>
  </div>
</section>

    <section x-show="view==='agents'" x-cloak>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Agents</h2>
        <div class="flex gap-2">
          <button class="bg-green-600 text-white px-3 py-2 rounded" @click="openModal('addAgent')">‚ûï Add</button>
          <button class="bg-white px-3 py-2 rounded border" @click="exportPDF('agents')"><i data-lucide="file-down" class="w-4 h-4 inline"></i> PDF</button>
          <button class="bg-white px-3 py-2 rounded border" @click="exportCSVServer('agents')"><i data-lucide="download" class="w-4 h-4 inline"></i> CSV</button>
        </div>
      </div>

      <div class="mb-2 flex items-center gap-2">
        <input id="filterAgents" name="filterAgents" placeholder="Filter or search..." x-model="filterText" @input="fetchAgents()" class="p-2 border rounded w-1/3" />
        <div class="ml-auto text-sm opacity-70">Showing <span x-text="agentsCountDisplay"></span></div>
      </div>

      <div class="bg-white rounded shadow overflow-auto">
        <table class="min-w-full text-sm" role="table" aria-label="Agents table">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 text-left cursor-sort" @click="changeSort('name', 'agents')">Name <i data-lucide="chevrons-up-down" class="w-4 h-4 inline"></i></th>
              <th class="p-2 text-left cursor-sort" @click="changeSort('contact','agents')">Contact <i data-lucide="chevrons-up-down" class="w-4 h-4 inline"></i></th>
              <th class="p-2 text-left">Supervisor</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="a in agents" :key="a.agent_id">
              <tr class="border-b hover:bg-slate-50">
                <td class="p-2" x-text="a.name"></td>
                <td class="p-2" x-text="a.contact"></td>
                <td class="p-2" x-text="a.supervisor_name || '‚Äî'"></td>
                <td class="p-2">
                  <button @click="openModal('editAgent', a)" class="p-2 rounded hover:bg-slate-100" title="Edit agent"><i data-lucide="edit" class="w-4 h-4"></i></button>
                  <button @click="confirmDeleteAgent(a.agent_id)" class="p-2 rounded hover:bg-slate-100 text-red-500" title="Delete agent"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between mt-3">
        <div>
          <button class="px-3 py-1 border rounded mr-2" :disabled="agtPage===1" @click="changePage('prev','agents')">‚¨Ö Prev</button>
          <button class="px-3 py-1 border rounded" :disabled="(agtPage * agtPageSize) >= agentsTotal" @click="changePage('next','agents')">Next ‚û°</button>
        </div>
        <div class="text-sm opacity-80">Page <span x-text="agtPage"></span> ‚Ä¢ Page size
          <select x-model.number="agtPageSize" @change="fetchAgents()" class="ml-2 border rounded p-1" aria-label="Agents page size">
            <option :value="10">10</option><option :value="25">25</option><option :value="50">50</option>
          </select>
        </div>
      </div>
    </section>
<section x-show="view==='supervisors'" x-cloak>
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Supervisors</h2>
    <div class="flex gap-2">
      <button class="bg-green-600 text-white px-3 py-2 rounded" @click="openModal('addSupervisor')">‚ûï Add Supervisor</button>
      <button class="bg-white px-3 py-2 rounded border" @click="exportPDF('supervisors')">PDF</button>
      <button class="bg-white px-3 py-2 rounded border" @click="exportCSVServer('supervisors')">CSV</button>
    </div>
  </div>

  <div class="mb-2 flex items-center gap-2">
    <input id="filterSupervisors" name="filterSupervisors" placeholder="Filter or search..." x-model="filterText" @input="fetchSupervisors()" class="p-2 border rounded w-1/3" />
    <div class="ml-auto text-sm opacity-70">Showing <span x-text="supervisorsCountDisplay"></span></div>
  </div>

  <div class="bg-white rounded shadow overflow-auto">
    <table class="min-w-full text-sm" role="table" aria-label="Supervisors table">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-2 text-left cursor-sort" @click="changeSort('name','supervisors')">Name <i data-lucide="chevrons-up-down" class="w-4 h-4 inline"></i></th>
          <th class="p-2 text-left cursor-sort" @click="changeSort('region','supervisors')">Region <i data-lucide="chevrons-up-down" class="w-4 h-4 inline"></i></th>
          <th class="p-2 text-left">Agents</th>
          <th class="p-2 text-left">POS Assigned</th>
          <th class="p-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="s in supervisors" :key="s.supervisor_id">
          <tr class="border-b hover:bg-slate-50">
            <td class="p-2" x-text="s.name"></td>
            <td class="p-2" x-text="s.region"></td>
            <td class="p-2" x-text="s.agent_count || 0"></td>
            <td class="p-2" x-text="s.pos_assigned || 0"></td>
            <td class="p-2">
              <button @click="openModal('editSupervisor', s)" class="p-2 rounded hover:bg-slate-100" title="Edit"><i data-lucide="edit" class="w-4 h-4"></i></button>
              <button @click="confirmDeleteSupervisor(s.supervisor_id)" class="p-2 rounded hover:bg-slate-100 text-red-500" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

  <div class="flex items-center justify-between mt-3">
    <div>
      <button class="px-3 py-1 border rounded mr-2" :disabled="supPage===1" @click="changePage('prev','supervisors')">‚¨Ö Prev</button>
      <button class="px-3 py-1 border rounded" :disabled="(supPage*supPageSize) >= supervisorsTotal" @click="changePage('next','supervisors')">Next ‚û°</button>
    </div>
    <div class="text-sm opacity-80">Page <span x-text="supPage"></span> ‚Ä¢ Page size
      <select x-model.number="supPageSize" @change="fetchSupervisors()" class="ml-2 border rounded p-1">
        <option :value="10">10</option>
        <option :value="25">25</option>
        <option :value="50">50</option>
      </select>
    </div>
  </div>
</section>

    <section x-show="view==='pos'" x-cloak>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">POS Devices</h2>
        <button class="bg-green-600 text-white px-3 py-2 rounded" @click="openModal('addPOS')">‚ûï Add POS</button>
      </div>

      <div class="bg-white rounded shadow overflow-auto">
        <table class="min-w-full text-sm" role="table" aria-label="POS devices table">
          <thead class="bg-slate-100">
            <tr><th class="p-2">Serial</th><th class="p-2">Agent</th><th class="p-2">Status</th><th class="p-2">Condition</th><th class="p-2">Actions</th></tr>
          </thead>
          <tbody>
            <template x-for="p in pos_devices" :key="p.pos_id">
              <tr class="border-b hover:bg-slate-50">
                <td class="p-2" x-text="p.serial_number"></td>
                <td class="p-2" x-text="p.agent_name || '‚Äî'"></td>
                <td class="p-2" x-text="p.status"></td>
                <td class="p-2" x-text="p.condition"></td>
                <td class="p-2">
                  <button @click="openModal('editPOS', p)" class="p-2 rounded hover:bg-slate-100" title="Edit POS"><i data-lucide="edit" class="w-4 h-4"></i></button>
                  <button @click="confirmDeletePOS(p.pos_id)" class="p-2 rounded hover:bg-slate-100 text-red-500" title="Delete POS"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>

    <section x-show="view==='logs'" x-cloak>
      <h2 class="text-2xl font-bold mb-4">Activity Logs</h2>
      <div class="mb-3 flex gap-2">
        <input id="logsFilter" name="logsFilter" x-model="logsFilter" @input="applyLogsFilter()" placeholder="Filter logs..." class="p-2 border rounded w-1/3" />
        <button class="bg-white px-3 py-2 rounded border" @click="exportLogsCSV()">üì§ Export Logs CSV</button>
        <button class="bg-white px-3 py-2 rounded border" @click="exportPDF('activity_logs')">üßæ Export Logs PDF</button>
      </div>
      <div class="bg-white rounded shadow p-4 h-96 overflow-auto">
        <template x-for="l in filteredActivityLogs" :key="l.id">
          <div class="mb-3">
            <div class="text-sm font-medium" x-text="(l.user_name || 'ICT') + ' ‚Ä¢ ' + (new Date(l.created_at)).toLocaleString()"></div>
            <div class="text-xs opacity-70" x-text="l.action + (l.details ? (' ‚Äî ' + l.details) : '')"></div>
          </div>
        </template>
      </div>
    </section>

    <section x-show="view==='settings'" x-cloak>
      <h2 class="text-2xl font-bold mb-4">Settings</h2>
      <div class="bg-white rounded shadow p-4 max-w-xl">
        <div class="mb-3">
          <label for="adminName" class="block text-sm mb-1">Admin Name</label>
          <input id="adminName" name="adminName" x-model="settings.admin_name" class="w-full p-2 border rounded" autocomplete="name" />
        </div>
        <div class="mb-3">
          <label for="adminEmail" class="block text-sm mb-1">Email</label>
          <input id="adminEmail" name="adminEmail" x-model="settings.email" class="w-full p-2 border rounded" autocomplete="email" />
        </div>
        <div class="flex gap-2">
          <button @click="saveSettings()" class="bg-sky-700 text-white px-3 py-2 rounded">Save Settings</button>
          <button @click="exportBackupJSON()" class="bg-white px-3 py-2 rounded border">üì• Download Backup</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modal drawer -->
<div x-show="modalOpen" x-cloak class="fixed inset-0 z-50 flex">
  <div @click="closeModal()" class="absolute inset-0 bg-black/40"></div>
  <div class="ml-auto w-full max-w-xl bg-white h-full shadow-lg p-6 overflow-auto slide-in" :class="modalOpen? 'show':''" role="dialog" aria-modal="true">
    <div class="flex items-start justify-between">
      <div>
        <h3 class="text-xl font-semibold" x-text="modalTitle"></h3>
        <p class="text-sm opacity-70" x-text="modalSubtitle"></p>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1 rounded border" @click="prevModalStep()" x-show="modalStep>1">‚Üê Back</button>
        <button class="px-3 py-1 rounded border" @click="closeModal()">Close</button>
      </div>
    </div>

    <div class="mt-4">
      <!-- Supervisor modal -->
      <div x-show="modalType==='addSupervisor' || modalType==='editSupervisor'">
        <div x-show="modalStep===1" class="fade-scale" :class="modalStep===1? 'show':''">
          <label class="block mb-2" for="supName">Name
            <input id="supName" name="supName" class="w-full p-2 border rounded" x-model="form.name" autocomplete="name" />
          </label>
          <label class="block mb-2" for="supRegion">Region
            <input id="supRegion" name="supRegion" class="w-full p-2 border rounded" x-model="form.region" />
          </label>
          <div class="flex justify-end"><button class="bg-sky-700 text-white px-4 py-2 rounded" @click="nextModalStep()">Next</button></div>
        </div>
        <div x-show="modalStep===2" class="fade-scale" :class="modalStep===2? 'show':''">
          <h4 class="font-semibold">Confirm</h4>
          <div class="mb-3">
            <div><strong>Name:</strong> <span x-text="form.name"></span></div>
            <div><strong>Region:</strong> <span x-text="form.region"></span></div>
          </div>
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded border" @click="prevModalStep()">Back</button>
            <button class="bg-green-600 text-white px-3 py-2 rounded" @click="modalType==='addSupervisor'? addSupervisorConfirm() : updateSupervisorConfirm()">Confirm</button>
          </div>
        </div>
      </div>

      <!-- Agent modal -->
      <div x-show="modalType==='addAgent' || modalType==='editAgent'">
        <div x-show="modalStep===1" class="fade-scale" :class="modalStep===1? 'show':''">
          <label class="block mb-2" for="agtName">Name
            <input id="agtName" name="agtName" class="w-full p-2 border rounded" x-model="form.name" autocomplete="name" />
          </label>
          <label class="block mb-2" for="agtContact">Contact
            <input id="agtContact" name="agtContact" class="w-full p-2 border rounded" x-model="form.contact" autocomplete="tel" />
          </label>
          <label class="block mb-2" for="agtLocation">Location
            <input id="agtLocation" name="agtLocation" class="w-full p-2 border rounded" x-model="form.location" />
          </label>
          <label class="block mb-2" for="agtSupervisor">Supervisor
            <select id="agtSupervisor" name="agtSupervisor" class="w-full p-2 border rounded" x-model="form.supervisor_id">
              <option value="">Select</option>
              <template x-for="s in supSelect" :key="s.supervisor_id"><option :value="s.supervisor_id" x-text="s.name"></option></template>
            </select>
          </label>
          <div class="flex justify-end"><button class="bg-sky-700 text-white px-4 py-2 rounded" @click="nextModalStep()">Next</button></div>
        </div>
        <div x-show="modalStep===2" class="fade-scale" :class="modalStep===2? 'show':''">
          <h4 class="font-semibold">Confirm Agent</h4>
          <div class="mb-3">
            <div><strong>Name:</strong> <span x-text="form.name"></span></div>
            <div><strong>Supervisor:</strong> <span x-text="(supSelect.find(s=>s.supervisor_id===form.supervisor_id)||{name:''}).name"></span></div>
          </div>
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded border" @click="prevModalStep()">Back</button>
            <button class="bg-green-600 text-white px-3 py-2 rounded" @click="modalType==='addAgent'? addAgentConfirm() : updateAgentConfirm()">Confirm</button>
          </div>
        </div>
      </div>

      <!-- POS modal -->
      <div x-show="modalType==='addPOS' || modalType==='editPOS'">
        <div x-show="modalStep===1" class="fade-scale" :class="modalStep===1? 'show':''">
          <label class="block mb-2" for="posSerial">Serial Number
            <input id="posSerial" name="posSerial" class="w-full p-2 border rounded" x-model="form.serial_number" />
          </label>
          <label class="block mb-2" for="posAgent">Assign to Agent
            <select id="posAgent" name="posAgent" class="w-full p-2 border rounded" x-model="form.agent_id">
              <option value="">Unassigned</option>
              <template x-for="a in all_agents" :key="a.agent_id"><option :value="a.agent_id" x-text="a.name"></option></template>
            </select>
          </label>
          <label class="block mb-2" for="posStatus">Status
            <select id="posStatus" name="posStatus" class="w-full p-2 border rounded" x-model="form.status"><option>Available</option><option>Active</option><option>Returned</option><option>Inactive</option></select>
          </label>
          <label class="block mb-2" for="posCondition">Condition
            <select id="posCondition" name="posCondition" class="w-full p-2 border rounded" x-model="form.condition"><option>Excellent</option><option>Good</option><option>Needs Repair</option><option>Damaged</option></select>
          </label>
          <div class="flex justify-end"><button class="bg-sky-700 text-white px-4 py-2 rounded" @click="nextModalStep()">Next</button></div>
        </div>
        <div x-show="modalStep===2" class="fade-scale" :class="modalStep===2? 'show':''">
          <h4 class="font-semibold">Confirm POS</h4>
          <div class="mb-3">
            <div><strong>Serial:</strong> <span x-text="form.serial_number"></span></div>
            <div><strong>Agent:</strong> <span x-text="(all_agents.find(x=>x.agent_id===form.agent_id)||{name:'Unassigned'}).name"></span></div>
          </div>
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded border" @click="prevModalStep()">Back</button>
            <button class="bg-green-600 text-white px-3 py-2 rounded" @click="modalType==='addPOS'? addPOSConfirm() : updatePOSConfirm()">Confirm</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast area (local, compatible with Alpine.store) -->
<div x-data="{ toasts: [] }" x-init="$watch('toasts', () => { toasts.forEach(t => setTimeout(()=> toasts.splice(toasts.indexOf(t),1), 4200)) })" class="fixed top-4 right-4 z-50 pointer-events-none">
  <template x-for="(t,i) in toasts" :key="i">
    <div class="bg-white border rounded shadow px-4 py-2 mb-2 pointer-events-auto flex items-center gap-3">
      <div class="text-2xl" x-text="t.emoji"></div>
      <div>
        <div class="font-medium" x-text="t.title"></div>
        <div class="text-sm opacity-70" x-text="t.message"></div>
      </div>
    </div>
  </template>
</div>
<div x-data="app()" x-init="fetchAgents()">

  <!-- Loop through supervisors and their agents -->
  <template x-for="group in agentsPerSupervisor" :key="group.supervisor">
    <div class="mb-4 border p-3 rounded">
      <h3 class="font-bold" x-text="group.supervisor"></h3>
      <ul>
        <template x-for="agent in group.agents" :key="agent.id">
          <li x-text="agent.name"></li>
        </template>
      </ul>
    </div>
  </template>

  


</div>
<!-- BEGIN: Blue Star Assistant (place before </body>) -->
<!-- Assistant panel -->
<div id="chatPanel" class="bst-chat-panel hidden" aria-hidden="true">
  <div class="chat-header">
    <button id="closeBtnAssistant" class="close-btn">‚úñ</button>
    <h3>Assistant</h3>
  </div>
  <div class="chat-body">
    <!-- Chat content here -->
  </div>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    // Toast store
    Alpine.store('toasts', {
      items: [],
      pushSimple(title, emoji = 'üîî', message = '') {
        this.items.push({ title, message, emoji, id: Date.now() });
        // Auto-dismiss oldest after 3.5s
        setTimeout(() => {
          if (this.items.length) this.items.shift();
        }, 3500); 
      },
      dismiss(id) {
        this.items = this.items.filter(toast => toast.id !== id);
      }
    });
  });

/* -------------------------
  Main Alpine app
------------------------- */
function app(){
  return {
    agentsPerSupervisor: [],
    view: 'dashboard',
    supabase: window.supabase,
    /* counts */
    counts: { supervisors:0, agents:0, pos:0, requests_pending:0 },
    /* search & filters */
    globalSearch: '', filterText: '', logsFilter: '',
    /* pagination & sorting (supervisors) */
    supPage: 1, supPageSize: 10, supSortColumn: 'name', supSortDir: 'asc', supervisorsTotal: 0,
    /* pagination & sorting (agents) */
    agtPage: 1, agtPageSize: 10, agtSortColumn: 'name', agtSortDir: 'asc', agentsTotal: 0,
    /* data */
    supervisors: [], agents: [], all_agents: [], pos_devices: [], pos_requests: [], activity_logs: [],
    /* modal */
    modalOpen: false, modalType: '', modalStep: 1, form: {}, modalTitle: '', modalSubtitle: '',
    supSelect: [],
    /* settings */
    settings: { admin_name:'ICT Officer', email:'', theme:'light', notifications:true },
    /* charts */
    chartAgents: null,
    chartType: localStorage.getItem('bst_chartType') || 'bar',
    _isToggling: false,

    /* init: run after Alpine loads */
    async initApp() {
      try {
        // load settings first
        await this.loadSettings();
        await Promise.all([
          this.fetchSupervisors(),
          this.fetchAgents(),
          this.fetchPOS(),
          this.fetchActivityLogs()
        ]);
      } catch (e) {
        console.warn('data load error', e);
      }
function renderIcons() {
  lucide.createIcons();
}

// Call once after page load
renderIcons();

// Also call after data changes that render buttons/icons dynamically
document.addEventListener('alpine:updated', () => {
  renderIcons();
});

      this.updateCounts();
      this.setupRealtime();

      // protect against chart errors
      try {
        this.$nextTick(() => this.initChart());
      } catch (err) {
        console.warn('chart init skipped:', err);
      }

      // Wire Alpine.store to local toasts UI
      this.syncToastStore();
    },

    /* keep a live mirror of Alpine.store('toasts') into local toasts array for UI */
    syncToastStore() {
      try {
        const store = Alpine.store('toasts');
        // reactive update - poll-based fallback
        setInterval(() => {
          if (JSON.stringify(this.toasts) !== JSON.stringify(store.items)) {
            this.toasts = [...store.items];
          }
        }, 500);
      } catch(e){}
    },
exportAgentsPerSupervisorPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 10;
    this.agentsPerSupervisor.forEach(group => {
        doc.setFontSize(14);
        doc.text(group.supervisor, 10, y);
        y += 6;
        doc.setFontSize(12);
        group.agents.forEach(a => {
            doc.text(`- ${a.name} (${a.contact || 'No contact'})`, 14, y);
            y += 6;
            if (y > 280) { doc.addPage(); y = 10; }
        });
        y += 4;
    });

    doc.save('Agents_Per_Supervisor.pdf');
},
exportAgentsPerSupervisorCSV() {
    let csv = 'Supervisor,Agent Name,Contact\n';
    this.agentsPerSupervisor.forEach(group => {
        group.agents.forEach(a => {
            csv += `"${group.supervisor}","${a.name}","${a.contact || ''}"\n`;
        });
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'Agents_Per_Supervisor.csv';
    link.click();
    URL.revokeObjectURL(url);
},

    /* navigation */
    nav(viewName){
      this.view = viewName;
      // reset any modal state that could block clicks
      this.modalOpen = false;
      this.modalType = '';
      this.modalStep = 1;
      this.form = {};

      const titleMap = {
        dashboard:'Dashboard',
        supervisors:'Supervisors',
        agents:'Agents',
        pos:'POS Devices',
        logs:'Activity Logs',
        settings:'Settings'
      };
      const subMap = {
        dashboard:'Enterprise POS ‚Äî Internal Use Only',
        supervisors:'Manage and track field supervisors',
        agents:'Manage field agents',
        pos:'Track POS device inventory',
        logs:'View system activity log',
        settings:'Manage system settings and backups'
      };
      const t = titleMap[viewName] || 'Dashboard';
      const s = subMap[viewName] || '';
      const elTitle = document.getElementById('pageTitle');
      const elSub = document.getElementById('pageSub');
      if (elTitle) elTitle.innerText = t;
      if (elSub) elSub.innerText = s;
    },

    /* ---------- SERVER-SIDE: Supervisors (paging + sorting) ---------- */
    async fetchSupervisors(){
      try {
        const start = (this.supPage - 1) * this.supPageSize;
        const end = start + this.supPageSize - 1;
        const { data, error } = await this.supabase.from('supervisors')
          .select('*', { count: 'exact' })
          .ilike('name', `%${this.filterText || ''}%`)
          .order(this.supSortColumn, { ascending: this.supSortDir === 'asc' })
          .range(start, end);
        if(error) throw error;
        this.supervisors = data || [];
        // fetch total count separately (Supabase sometimes needs head:true)
        const cnt = await this.supabase.from('supervisors').select('supervisor_id',{ count: 'exact', head: true }).ilike('name', `%${this.filterText || ''}%`);
        this.supervisorsTotal = cnt.count || (data||[]).length;
        // derived fields
        await this.attachSupervisorDerived();
        // Update supervisor select for modals
        this.supSelect = this.supervisors || [];
        this.updateChart();
      } catch(e){ console.error('fetchSupervisors', e); this.notifyError('Fetch supervisors failed', e); }
    },

    // derived fields for supervisors
    async attachSupervisorDerived(){
      try {
        const { data: allAgents } = await this.supabase.from('agents').select('*');
        const { data: allPos } = await this.supabase.from('pos_devices').select('*');
        this.all_agents = allAgents || [];
        this.pos_devices = (allPos || []).map(p => ({ ...p }));
        for(const s of this.supervisors){
          s.agent_count = (this.all_agents || []).filter(a => a.supervisor_id === s.supervisor_id).length;
          s.pos_assigned = (this.pos_devices || []).filter(p => {
            const ag = this.all_agents.find(x => x.agent_id === p.agent_id);
            return ag && ag.supervisor_id === s.supervisor_id;
          }).length;
        }
      } catch(e){ console.error('attachSupervisorDerived', e);}
    },

    changeSort(column, which){
      if(which === 'supervisors'){
        if(this.supSortColumn === column) this.supSortDir = this.supSortDir === 'asc' ? 'desc' : 'asc';
        else { this.supSortColumn = column; this.supSortDir = 'asc'; }
        this.fetchSupervisors();
      } else {
        if(this.agtSortColumn === column) this.agtSortDir = this.agtSortDir === 'asc' ? 'desc' : 'asc';
        else { this.agtSortColumn = column; this.agtSortDir = 'asc'; }
        this.fetchAgents();
      }
    },

    changePage(direction, which){
      if(which==='supervisors'){
        if(direction==='next') this.supPage++; else if(direction==='prev' && this.supPage>1) this.supPage--;
        this.fetchSupervisors();
      } else {
        if(direction==='next') this.agtPage++; else if(direction==='prev' && this.agtPage>1) this.agtPage--;
        this.fetchAgents();
      }
    },

    get supervisorsCountDisplay(){ return `${Math.min(this.supPage * this.supPageSize, this.supervisorsTotal || this.supervisors.length)} / ${this.supervisorsTotal || this.supervisors.length}`; },

    /* ---------- SERVER-SIDE: Agents (paging + sorting) ---------- */
    async fetchAgents(){
      try {
        const start = (this.agtPage - 1) * this.agtPageSize;
        const end = start + this.agtPageSize - 1;
        const { data, error } = await this.supabase.from('agents').select('*,supervisor:supervisor_id(name)').ilike('name', `%${this.filterText||''}%`).order(this.agtSortColumn, { ascending: this.agtSortDir==='asc' }).range(start, end);
        if(error) throw error;
        this.agents = (data || []).map(a => ({ ...a, supervisor_name: a.supervisor?.name || '' }));
        const cnt = await this.supabase.from('agents').select('agent_id',{ count:'exact', head:true }).ilike('name', `%${this.filterText||''}%`);
        this.agentsTotal = cnt.count || (data||[]).length;
        // Also update all_agents for POS modal if needed
        this.all_agents = (await this.supabase.from('agents').select('*')).data || [];
      } catch(e){ console.error('fetchAgents', e); this.notifyError('Fetch agents failed', e); }
    },

    get agentsCountDisplay(){ return `${Math.min(this.agtPage * this.agtPageSize, this.agentsTotal || this.agents.length)} / ${this.agentsTotal || this.agents.length}`; },

    /* ---------- POS & Logs ---------- */
    async fetchPOS(){
      try {
        const { data, error } = await this.supabase.from('pos_devices').select('*,agent_id(name,agent_id)').order('serial_number');
        if(error) throw error;
        this.pos_devices = (data || []).map(p => ({ ...p, agent_name: p.agent_id ? p.agent_id.name : '' }));
      } catch(e){ console.error('fetchPOS', e); this.notifyError('Fetch POS failed', e); }
    },

    async fetchActivityLogs(){
      try {
        const { data, error } = await this.supabase.from('activity_logs').select('*').order('created_at', { ascending: false }).limit(1000);
        if(error) throw error;
        this.activity_logs = data || [];
      } catch(e){ console.error('fetchActivityLogs', e); this.notifyError('Fetch logs failed', e); }
    },

    applyLogsFilter(){
      // client-side filtered via getter
    },

    get filteredActivityLogs(){
      if(!this.logsFilter) return this.activity_logs;
      const filter = this.logsFilter.toLowerCase();
      return this.activity_logs.filter(l => 
        (l.action||'').toLowerCase().includes(filter) || 
        (l.details||'').toLowerCase().includes(filter) ||
        (l.user_name||'').toLowerCase().includes(filter)
      );
    },

    applySearch(){ this.supPage=1; this.agtPage=1; this.fetchSupervisors(); this.fetchAgents(); },

    async refreshAll(){ await Promise.all([ this.fetchSupervisors(), this.fetchAgents(), this.fetchPOS(), this.fetchActivityLogs() ]); this.updateCounts(); this.updateChart(); },

    updateCounts(){ this.counts.supervisors = this.supervisorsTotal || this.supervisors.length; this.counts.agents = this.agentsTotal || this.agents.length; this.counts.pos = this.pos_devices.length; },

    /* ---------- MODALS ---------- */
    openModal(type, payload=null){
      this.modalType = type; this.modalStep = 1;
      this.form = payload ? JSON.parse(JSON.stringify(payload)) : {};
      this.modalTitle = ({ addSupervisor:'Add Supervisor', editSupervisor:'Edit Supervisor', addAgent:'Add Agent', editAgent:'Edit Agent', addPOS:'Add POS', editPOS:'Edit POS' })[type] || '';
      this.modalSubtitle = 'Step 1 ‚Äî Details';
      this.modalOpen = true;
      // Ensure supSelect is current when opening the Agent modal
      if (type.includes('Agent')) {
          this.supSelect = this.supervisors.length ? this.supervisors : [];
      }
    },

    closeModal(){ this.modalOpen=false; this.modalType=''; this.modalStep=1; this.form={}; this.modalTitle=''; this.modalSubtitle=''; },

    nextModalStep(){ if(this.modalStep<2){ this.modalStep++; this.modalSubtitle='Step 2 ‚Äî Confirm'; } },
    prevModalStep(){ if(this.modalStep>1){ this.modalStep--; this.modalSubtitle='Step 1 ‚Äî Details'; } },

    /* ---------- Supervisor CRUD ---------- */
    async addSupervisorConfirm(){
      if(!this.form.name) return alert('Name required');
      try {
        const { error } = await this.supabase.from('supervisors').insert([{ name: this.form.name, region: this.form.region }]);
        if(error) throw error;
        await this.logActivity('Added supervisor', `Name: ${this.form.name}`);
        Alpine.store('toasts').pushSimple('Supervisor added','üë•', this.form.name);
        this.closeModal(); this.fetchSupervisors(); this.fetchAgents(); this.fetchPOS();
      } catch(e){ alert(e.message || 'Failed to add supervisor'); console.error(e); }
    },

    async updateSupervisorConfirm(){
      if(!this.form.name) return alert('Name required');
      try {
        const { error } = await this.supabase.from('supervisors').update({ name: this.form.name, region: this.form.region }).eq('supervisor_id', this.form.supervisor_id);
        if(error) throw error;
        await this.logActivity('Edited supervisor', `ID: ${this.form.supervisor_id}`);
        Alpine.store('toasts').pushSimple('Supervisor updated','‚úèÔ∏è', this.form.name);
        this.closeModal(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to update supervisor'); console.error(e); }
    },

    confirmDeleteSupervisor(id){ if(confirm('Delete supervisor?')) this.deleteSupervisor(id); },

    async deleteSupervisor(id){
      try {
        const { error } = await this.supabase.from('supervisors').delete().eq('supervisor_id', id);
        if(error) throw error;
        await this.logActivity('Deleted supervisor', `ID: ${id}`);
        Alpine.store('toasts').pushSimple('Supervisor deleted','üóëÔ∏è', `ID: ${id}`);
        this.fetchSupervisors(); this.fetchAgents(); this.fetchPOS();
      } catch(e){ alert(e.message || 'Failed to delete supervisor'); console.error(e); }
    },

    /* ---------- Agent CRUD ---------- */
    async addAgentConfirm(){
      if(!this.form.name || !this.form.supervisor_id) return alert('Name & Supervisor required');
      try {
        const { error } = await this.supabase.from('agents').insert([{ name: this.form.name, contact: this.form.contact, location: this.form.location, supervisor_id: this.form.supervisor_id }]);
        if(error) throw error;
        await this.logActivity('Added agent', `Name: ${this.form.name}`);
        Alpine.store('toasts').pushSimple('Agent added','üë§', this.form.name);
        this.closeModal(); this.fetchAgents(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to add agent'); console.error(e); }
    },

    async updateAgentConfirm(){
      try {
        const { error } = await this.supabase.from('agents').update({ name: this.form.name, contact: this.form.contact, location: this.form.location, supervisor_id: this.form.supervisor_id }).eq('agent_id', this.form.agent_id);
        if(error) throw error;
        await this.logActivity('Edited agent', `ID: ${this.form.agent_id}`);
        Alpine.store('toasts').pushSimple('Agent updated','‚úèÔ∏è', this.form.name);
        this.closeModal(); this.fetchAgents(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to update agent'); console.error(e); }
    },

    confirmDeleteAgent(id){ if(confirm('Delete agent?')) this.deleteAgent(id); },

    async deleteAgent(id){
      try {
        const { error } = await this.supabase.from('agents').delete().eq('agent_id', id);
        if(error) throw error;
        await this.logActivity('Deleted agent', `ID: ${id}`);
        Alpine.store('toasts').pushSimple('Agent deleted','üóëÔ∏è', `ID: ${id}`);
        this.fetchAgents(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to delete agent'); console.error(e); }
    },

    /* ---------- POS CRUD ---------- */
    async addPOSConfirm(){
      if(!this.form.serial_number) return alert('Serial required');
      try {
        const { error } = await this.supabase.from('pos_devices').insert([{ serial_number: this.form.serial_number, agent_id: this.form.agent_id || null, date_issued: null, status: this.form.status || 'Available', condition: this.form.condition || 'Good', notes: this.form.notes || '' }]);
        if(error) throw error;
        await this.logActivity('Added POS', `Serial: ${this.form.serial_number}`);
        Alpine.store('toasts').pushSimple('POS added','üì¶', this.form.serial_number);
        this.closeModal(); this.fetchPOS(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to add POS'); console.error(e); }
    },

    async updatePOSConfirm(){
      try {
        const { error } = await this.supabase.from('pos_devices').update({ serial_number: this.form.serial_number, agent_id: this.form.agent_id || null, status: this.form.status, condition: this.form.condition, notes: this.form.notes || '' }).eq('pos_id', this.form.pos_id);
        if(error) throw error;
        await this.logActivity('Edited POS', `POS ID: ${this.form.pos_id}`);
        Alpine.store('toasts').pushSimple('POS updated','üì¶', this.form.serial_number);
        this.closeModal(); this.fetchPOS(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to update POS'); console.error(e); }
    },

    confirmDeletePOS(id){ if(confirm('Delete POS?')) this.deletePOS(id); },

    async deletePOS(id){
      try {
        const { error } = await this.supabase.from('pos_devices').delete().eq('pos_id', id);
        if(error) throw error;
        await this.logActivity('Deleted POS', `POS ID: ${id}`);
        Alpine.store('toasts').pushSimple('POS deleted','üì¶', `ID: ${id}`);
        this.fetchPOS(); this.fetchSupervisors();
      } catch(e){ alert(e.message || 'Failed to delete POS'); console.error(e); }
    },

    /* ---------- Activity logs & Notifications ---------- */
    async logActivity(action, details=''){
      try { await this.supabase.from('activity_logs').insert([{ user_role:'ICT', user_name:this.settings.admin_name||'ICT', action, details }]); } catch(e){ console.error(e); }
      this.fetchActivityLogs();
    },

    async notifyDB(title, message, type='info'){ try { await this.supabase.from('notifications').insert([{ title, message, type }]); } catch(e){ console.error(e); } },

    pushToast(title, emoji='üîî', message=''){
      try { Alpine.store('toasts').pushSimple(title, emoji, message); } catch(e){
        // fallback - local UI component
        const comps = Array.from(document.querySelectorAll('[x-data]')).map(n => n.__x).filter(x => x && x.$data && x.$data.toasts !== undefined);
        if(comps.length){ comps[0].$data.toasts.push({ title, message, emoji }); }
      }
    },

    /* ---------- Charts ---------- */

    toggleChartType() {
      if (this._isToggling) return;
      this._isToggling = true;

      this.chartType = this.chartType === 'bar' ? 'pie' : 'bar';
      localStorage.setItem('bst_chartType', this.chartType);

      if (this.chartAgents) {
        try { this.chartAgents.destroy(); } catch {}
        this.chartAgents = null;
      }

      setTimeout(() => {
        this.initChart();
        this._isToggling = false;
      }, 300);
    },

    /* ---------- Realtime (Supabase Realtime channels) ---------- */
    setupRealtime(){
      try {
        const channel = this.supabase.channel('realtime-ict')
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'activity_logs' }, payload => {
            try { Alpine.store('toasts').pushSimple(payload.new.action || 'Activity','üßæ', payload.new.details || ''); } catch {}
            this.fetchActivityLogs();
          })
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'supervisors' }, payload => {
            try { Alpine.store('toasts').pushSimple('Supervisor added','üë•', payload.new.name || ''); } catch {}
            this.fetchSupervisors();
          })
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'agents' }, payload => {
            try { Alpine.store('toasts').pushSimple('Agent added','üë§', payload.new.name || ''); } catch {}
            this.fetchAgents();
          })
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'pos_devices' }, payload => {
            try { Alpine.store('toasts').pushSimple('POS added','üì¶', payload.new.serial_number || ''); } catch {}
            this.fetchPOS();
          })
          .subscribe();
      } catch(e){ console.warn('Realtime setup failed', e); }
    },

    /* ---------- SETTINGS & BACKUP ---------- */
    async loadSettings(){ try { const { data } = await this.supabase.from('settings').select('*').eq('id',1).maybeSingle(); if(data) this.settings = { ...this.settings, ...data }; } catch(e){ console.warn('loadSettings', e); } },
    async saveSettings(){ try { await this.supabase.from('settings').upsert([{ id:1, admin_name:this.settings.admin_name, email:this.settings.email, theme:this.settings.theme, notifications:this.settings.notifications }], { onConflict:'id' }); Alpine.store('toasts').pushSimple('Settings saved','‚öôÔ∏è',''); await this.logActivity('Updated settings', `Admin: ${this.settings.admin_name}`); } catch(e){ alert('Error saving settings'); console.error(e); } },

    async exportBackupJSON(){
      try {
        const [supRes, agRes, posRes, reqRes, logsRes] = await Promise.all([
          this.supabase.from('supervisors').select('*'),
          this.supabase.from('agents').select('*'),
          this.supabase.from('pos_devices').select('*'),
          this.supabase.from('pos_requests').select('*'),
          this.supabase.from('activity_logs').select('*')
        ]);
        const payload = { supervisors: supRes.data||[], agents: agRes.data||[], pos_devices: posRes.data||[], pos_requests: reqRes.data||[], activity_logs: logsRes.data||[], settings: this.settings };
        const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        Alpine.store('toasts').pushSimple('Backup downloaded','üì•','');
      } catch(e){ alert('Backup failed'); console.error(e); }
    },

    /* ---------- CSV / PDF exports ---------- */
    async exportCSVServer(table){
      try {
        const { data, error } = await this.supabase.from(table).select('*');
        if(error){ alert(error.message); return; }
        if(!data || !data.length){ alert('No data to export'); return; }
        const headers = Object.keys(data[0]);
        const rows = data.map(r => headers.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','));
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${table}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        Alpine.store('toasts').pushSimple('CSV exported','üì§','');
      } catch(e){ alert('CSV export failed'); console.error(e); }
    },

    async exportAgentsCSV(supervisor_id, supervisor_name){
      try {
        const { data: agents } = await this.supabase.from('agents').select('*').eq('supervisor_id', supervisor_id).order('name');
        const { data: posList } = await this.supabase.from('pos_devices').select('*');
        const rows = (agents || []).map(a => [ a.agent_id, a.name, a.contact, a.location, (posList||[]).filter(p => p.agent_id === a.agent_id).map(p => p.serial_number).join('; ') ]);
        const headers = ['agent_id','name','contact','location','pos_assigned'];
        const csv = [ headers.join(','), ...rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')) ].join('\n');
        const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `agents_${(supervisor_name||'sup').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        Alpine.store('toasts').pushSimple(`Agents exported (${supervisor_name||''})`,'üì§','');
      } catch(e){ alert('Agents CSV failed'); console.error(e); }
    },

    exportLogsCSV(){
      try {
        const rows = (this.activity_logs || []).map(l => [ l.id, l.user_role, l.user_name, (l.action||'').replace(/[\r\n]+/g,' '), (l.details||'').replace(/[\r\n]+/g,' '), l.created_at ]);
        const headers = ['id','user_role','user_name','action','details','created_at'];
        const csv = [ headers.join(','), ...rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')) ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download = `activity_logs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        Alpine.store('toasts').pushSimple('Logs exported','üì§','');
      } catch(e){ alert('Logs CSV failed'); console.error(e); }
    },

    async exportPDF(table){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const { data, error } = await this.supabase.from(table).select('*');
        if(error){ alert(error.message); return; }
        if(!data || !data.length){ alert('No data to export'); return; }
        doc.text(`Report: ${table}`, 14, 18);
        (doc).autoTable({ startY: 24, head: [Object.keys(data[0])], body: data.map(r => Object.values(r)) });
        doc.save(`${table}_report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
        Alpine.store('toasts').pushSimple('PDF generated','üßæ','');
      } catch(e){ console.error(e); alert('PDF export failed'); }
    },

    async fetchAgentsPerSupervisor() {
      try {
        const { data: supervisors, error: supErr } = await this.supabase
          .from('supervisors')
          .select('supervisor_id, name');
        if (supErr) throw supErr;

        const { data: agents, error: agErr } = await this.supabase
          .from('agents')
          .select('agent_id, name, contact, supervisor_id');
        if (agErr) throw agErr;

        this.agentsPerSupervisor = supervisors.map(s => {
          return {
            supervisor: s.name,
            agents: agents.filter(a => a.supervisor_id === s.supervisor_id)
          }
        });
      } catch(e) {
        console.error('fetchAgentsPerSupervisor', e);
        alert('Failed to fetch report: ' + e.message);
      }
    },

    exportAgentsPerSupervisorPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      this.agentsPerSupervisor.forEach(group => {
        doc.setFontSize(14);
        doc.text(group.supervisor, 10, y);
        y += 6;
        doc.setFontSize(12);
        group.agents.forEach(a => {
          doc.text(`- ${a.name} (${a.contact || 'No contact'})`, 14, y);
          y += 6;
          if (y > 280) { doc.addPage(); y = 10; }
        });
        y += 4;
      });
      doc.save('Agents_Per_Supervisor.pdf');
    },

    exportAgentsPerSupervisorCSV() {
      let csv = 'Supervisor,Agent Name,Contact\n';
      this.agentsPerSupervisor.forEach(group => {
        group.agents.forEach(a => {
          csv += `"${group.supervisor}","${a.name}","${a.contact || ''}"\n`;
        });
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Agents_Per_Supervisor.csv';
      link.click();
      URL.revokeObjectURL(url);
    },

    /* ---------- Helpers ---------- */
    pushToastSimple(title, emoji='üîî', message=''){
      try { Alpine.store('toasts').pushSimple(title, emoji, message); } catch(e){ console.error(e); }
    },

    async logActivity(action, details=''){ try { await this.supabase.from('activity_logs').insert([{ user_role:'ICT', user_name:this.settings.admin_name || 'ICT', action, details }]); } catch(e){ console.error(e); } this.fetchActivityLogs(); },

    notifyError(title, e){ try { Alpine.store('toasts').pushSimple(title,'‚ö†Ô∏è', (e && e.message) ? e.message : String(e)); } catch(e2){} },

    /* wrapper helpers used in UI */
    confirmDeleteSupervisor(id){ if(confirm('Delete supervisor?')) this.deleteSupervisor(id); },
    confirmDeleteAgent(id){ if(confirm('Delete agent?')) this.deleteAgent(id); },
    confirmDeletePOS(id){ if(confirm('Delete POS?')) this.deletePOS(id); }
  
  };
}


/* When Alpine mounts, draw Lucide icons */
document.addEventListener('alpine:init', () => {
  try { lucide.createIcons(); } catch(e){}
});
</script>
 <style>
  /* Modal fade-scale animation */
  .fade-scale {
    transform: scale(0.95);
    opacity: 0;
    transition: all 0.2s ease-in-out;
  }
  .fade-scale.show {
    transform: scale(1);
    opacity: 1;
  }
  /* Tailwind base styles */
@tailwind base;
@tailwind components;
@tailwind utilities;

 </style>
 <script>
function updateGreetingAndTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');

    // Determine greeting
    let greeting = '';
    if (hours < 12) {
        greeting = 'Good MorningüåÖ';
    } else if (hours < 18) {
        greeting = 'Good Afternoonüåû';
    } else {
        greeting = 'Good Eveningüåú';
    }

    // Display greeting and time
    document.getElementById('greeting').textContent = `${greeting}, Admin!`; // Change "Admin" to dynamic username if available
    document.getElementById('time').textContent = `Current Time: ${hours}:${minutes}:${seconds}`;
}

// Initialize immediately
updateGreetingAndTime();
// Update every second
setInterval(updateGreetingAndTime, 1000);
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
  const assistantBtn = document.getElementById('assistantBtn');

  assistantBtn.addEventListener('click', () => {
    alert("Hi, I am currently under development");
  });
});

</script>

<script src="main.js"></script>
</body>
</html>
